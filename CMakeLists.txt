cmake_minimum_required(VERSION 3.22.2)
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
project(Lumin LANGUAGES CXX C)

set(LUA_EXPORT "LUA_API=extern \"C\" __declspec(dllexport)")
set(LUACODE_EXPORT "LUACODE_API=extern \"C\" __declspec(dllexport)")
set(LUACODEGEN_EXPORT "LUACODEGEN_API=extern \"C\" __declspec(dllexport)")
set(LUA_IMPORT "LUA_API=extern \"C\" __declspec(dllimport)")
set(LUACODE_IMPORT "LUACODE_API=extern \"C\" __declspec(dllimport)")
set(LUACODEGEN_IMPORT "LUACODEGEN_API=extern \"C\" __declspec(dllimport)")

set(LUMIN_LIBRARY_DIR Library)
set(LUMIN_SDK_DIR SDK)
set(LUMIN_MODULES_DIR Modules)
file(GLOB LUMIN_LIBRARY_SRC ${LUMIN_LIBRARY_DIR}/*.cpp)
file(GLOB LUMIN_SDK_SRC ${LUMIN_SDK_DIR}/*.cpp)
file(GLOB LUMIN_MODULE_DATE_TIME_SRC ${LUMIN_MODULES_DIR}/Date_Time/*.cpp)
file(GLOB LUMIN_MODULE_FILESYSTEM_SRC ${LUMIN_MODULES_DIR}/Filesystem/*.cpp)
file(GLOB LUMIN_MODULE_CONSOLE_SRC ${LUMIN_MODULES_DIR}/Console/*.cpp)

add_subdirectory(luau)
add_library(Lumin.Common INTERFACE)
add_library(Lumin.Library SHARED ${LUMIN_LIBRARY_SRC})
add_executable(Lumin.SDK WIN32 ${LUMIN_SDK_SRC})

add_library(Lumin.Module.Date_Time SHARED ${LUMIN_MODULE_DATE_TIME_SRC})
add_library(Lumin.Module.Filesystem SHARED ${LUMIN_MODULE_FILESYSTEM_SRC})
add_library(Lumin.Module.Console SHARED ${LUMIN_MODULE_CONSOLE_SRC})

target_include_directories(Lumin.Common INTERFACE Common)
target_link_libraries(Lumin.Common INTERFACE Lumin.Library)

target_compile_definitions(Luau.VM PUBLIC LUA_USE_LONGJMP=1)
target_compile_definitions(Luau.VM PRIVATE ${LUA_EXPORT})
target_compile_definitions(Luau.Compiler PRIVATE ${LUACODE_EXPORT})
target_compile_definitions(Luau.CodeGen PRIVATE ${LUACODEGEN_EXPORT})
target_compile_definitions(Lumin.Library PUBLIC ${LUA_IMPORT} ${LUACODE_IMPORT} ${LUACODEGEN_IMPORT})
target_compile_definitions(Lumin.Library PRIVATE ${LUA_EXPORT} ${LUACODE_EXPORT} ${LUACODEGEN_EXPORT} LUMIN_EXPORT_API)
target_include_directories(Lumin.Library PRIVATE ${LUMIN_LIBRARY_DIR})
target_include_directories(Lumin.Library PUBLIC ${LUMIN_LIBRARY_DIR}/include)
target_link_libraries(Lumin.Library PUBLIC Luau.VM Luau.Compiler Luau.CodeGen Lumin.Common)
target_link_libraries(Lumin.Library PRIVATE Luau.Config)
set_target_properties(Lumin.Library PROPERTIES OUTPUT_NAME lumin)

target_link_libraries(Lumin.SDK PRIVATE Lumin.Common)
set_target_properties(Lumin.SDK PROPERTIES OUTPUT_NAME lumin)

# standard module libraries
target_compile_definitions(Lumin.Module.Filesystem PRIVATE LUMIN_MODULES_EXPORT_API)
target_include_directories(Lumin.Module.Filesystem PRIVATE ${LUMIN_MODULES_DIR}/include)
set_target_properties(Lumin.Module.Filesystem PROPERTIES OUTPUT_NAME module.filesystem)
target_link_libraries(Lumin.Module.Filesystem PRIVATE Lumin.Library)

target_compile_definitions(Lumin.Module.Date_Time PRIVATE LUMIN_MODULES_EXPORT_API)
target_include_directories(Lumin.Module.Date_Time PRIVATE ${LUMIN_MODULES_DIR}/include)
set_target_properties(Lumin.Module.Date_Time PROPERTIES OUTPUT_NAME module.date_time)
target_link_libraries(Lumin.Module.Date_Time PRIVATE Lumin.Library)

target_compile_definitions(Lumin.Module.Console PRIVATE LUMIN_MODULES_EXPORT_API)
target_include_directories(Lumin.Module.Console PRIVATE ${LUMIN_MODULES_DIR}/include)
set_target_properties(Lumin.Module.Console PROPERTIES OUTPUT_NAME module.console)
target_link_libraries(Lumin.Module.Console PRIVATE Lumin.Library)
